

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Implicit gradient-enhanced damage model &mdash; FEniCS Constitutive 2020 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Note on iterative solvers" href="gradient_damage_iterative.html" />
    <link rel="prev" title="Material models" href="example.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> FEniCS Constitutive
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basic principle</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">Material models</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html#drucker-prager-yield-condition">Drucker-Prager yield condition</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implicit gradient-enhanced damage model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction-and-governing-equations">Introduction and governing equations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#damage-law">Damage law</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constitutive-law">Constitutive law</a></li>
<li class="toctree-l3"><a class="reference internal" href="#strain-norm">Strain norm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complete-constitutive-class">Complete constitutive class</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#quadrature-space-formulation">Quadrature space formulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comparison-with-the-analytic-solution">Comparison with the analytic solution</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#three-point-bending-test">Three-point bending test</a></li>
<li class="toctree-l2"><a class="reference internal" href="#extensions">Extensions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gradient_damage_iterative.html">Note on iterative solvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="helper.html">Helper classes and functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="plate_with_hole.html">Plate with hole</a></li>
<li class="toctree-l1"><a class="reference internal" href="ramberg_osgood.html">Ramberg Osgood material law</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">FEniCS Constitutive</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Implicit gradient-enhanced damage model</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/examples/gradient_damage.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implicit-gradient-enhanced-damage-model">
<h1>Implicit gradient-enhanced damage model<a class="headerlink" href="#implicit-gradient-enhanced-damage-model" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction-and-governing-equations">
<h2>Introduction and governing equations<a class="headerlink" href="#introduction-and-governing-equations" title="Permalink to this headline">¶</a></h2>
<p>A local isotropic damage model…</p>
<div class="math notranslate nohighlight">
\[\nabla \cdot \left( (1-\omega(\kappa(\| \boldsymbol \varepsilon \|)))
    \boldsymbol C : \boldsymbol \varepsilon \right)  = \boldsymbol 0\]</div>
<p>… is basically the modified linear-elastic momentum balance equation with</p>
<blockquote>
<div><ul class="simple">
<li><p>elasticity tensor <span class="math notranslate nohighlight">\(\boldsymbol C\)</span> - build from <span class="math notranslate nohighlight">\(E, \nu\)</span> or Lamé constants
<span class="math notranslate nohighlight">\(\lambda, \mu\)</span></p></li>
<li><p>damage <span class="math notranslate nohighlight">\(\omega \in [0,1)\)</span> that is driven by the history variable <span class="math notranslate nohighlight">\(\kappa\)</span></p></li>
<li><p>strains <span class="math notranslate nohighlight">\(\boldsymbol \varepsilon = \frac{1}{2}(\nabla \boldsymbol d + (\nabla \boldsymbol d)^T)\)</span>,
here in Voigt notation, meaning a vector of
<span class="math notranslate nohighlight">\([\boldsymbol \varepsilon_{xx}, \boldsymbol \varepsilon_{yy}, \frac{1}{2}\boldsymbol \varepsilon_{xy}]^T\)</span></p></li>
<li><p>the KKT conditions for <span class="math notranslate nohighlight">\(\kappa\)</span> translate to
<span class="math notranslate nohighlight">\(\kappa = \max(\kappa, \|\boldsymbol \varepsilon\|)\)</span>, where the latter term is a
scalar norm of the <em>local</em> strains</p></li>
</ul>
</div></blockquote>
<p>This <em>local</em> model exhibits various numerical problems, e.g. localization in
single bands of elements with a vanishing fracture energy upon mesh refinement.
One way to overcome these issues is to use nonlocal models that introduce a
mesh-independent length scale. Here, this is by replacing the <em>local</em> strain
norm with the <em>nonlocal equivalent strains</em> <span class="math notranslate nohighlight">\(\bar \varepsilon\)</span> as an additional
degree of freedom (DOF) that is calculated by a screened Poisson equation that
limits its curvature. Now, the full model reads</p>
<div class="math notranslate nohighlight">
\[\begin{split}\nabla \cdot \left( (1-\omega(\kappa(\bar \varepsilon))) \boldsymbol C : \boldsymbol \varepsilon \right)  &amp;= \boldsymbol 0  \\
\bar \varepsilon - l^2 \Delta \bar \varepsilon &amp;= \| \boldsymbol \varepsilon \|\end{split}\]</div>
<p>and details can be found, e.g.,  in</p>
<blockquote>
<div><ul class="simple">
<li><p>the original paper <a class="reference external" href="https://doi.org/10.1002/(SICI)1097-0207(19961015)39:19&lt;3391::AID-NME7&gt;3.0.CO;2-D">Gradient enhanced damage for quasi‐brittle materials, Peerlings et al., 1996</a> and</p></li>
<li><p>a more recent paper discussing alternative solution strategies <a class="reference external" href="https://doi.org/10.1061/(ASCE)EM.1943-7889.0001608">Implicit–explicit integration of gradient-enhanced damage models, Titscher et al., 2019</a></p></li>
</ul>
</div></blockquote>
<p>Next, we will discuss the building blocks of the constitutive model with the code.</p>
<p><strong>Remark: The functions in this section are written to work on multiple values
simultaneously. So instead of evaluating a function once per scalar, we group
the scalars in a (possibly huge) vector and apply the function once. This may
explain some strange syntax and slicing in the code below.</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">helper</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">dolfin.cpp.log</span> <span class="kn">import</span> <span class="n">log</span>
</pre></div>
</div>
<div class="section" id="damage-law">
<h3>Damage law<a class="headerlink" href="#damage-law" title="Permalink to this headline">¶</a></h3>
<p>The simplest case that is used in Peerlings et al. for an analytic solution is
the perfect damage model that, if inserted in the stress-strain relationship,
looks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">stress</span>
<span class="n">ft</span> <span class="o">|</span>   <span class="n">_______________</span>
   <span class="o">|</span>  <span class="o">/</span>
   <span class="o">|</span> <span class="o">/</span><span class="p">:</span>
   <span class="o">|/</span> <span class="p">:</span>
   <span class="mi">0</span><span class="o">--</span><span class="p">:</span><span class="o">--------------&gt;</span> <span class="n">strain</span>
      <span class="n">k0</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">damage_perfect</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">kappa</span><span class="p">):</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">ft</span> <span class="o">/</span> <span class="n">mat</span><span class="o">.</span><span class="n">E</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">k0</span> <span class="o">/</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">k0</span> <span class="o">/</span> <span class="n">kappa</span> <span class="o">**</span> <span class="mi">2</span>
</pre></div>
</div>
<p>For the characteristic strain softening, an exponential damage law is commonly
used. After reaching the peak load - the tensile strength <span class="math notranslate nohighlight">\(f_t\)</span>, the curve
shows an exponential drop to the residual stress <span class="math notranslate nohighlight">\((1-\alpha)f_t\)</span>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   stress
ft |
   |  /\
   | /: ` .
   |/ :     ` .. _____ (1-alpha)*ft
   0--:--------------&gt; strain
      k0
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">damage_exponential</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">ft</span> <span class="o">/</span> <span class="n">mat</span><span class="o">.</span><span class="n">E</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">alpha</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">beta</span>

    <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">k0</span> <span class="o">/</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">k0</span> <span class="o">-</span> <span class="n">k</span><span class="p">)))</span>
    <span class="n">dw</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">/</span> <span class="n">k</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">k</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">k0</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">dw</span>
</pre></div>
</div>
</div>
<div class="section" id="constitutive-law">
<h3>Constitutive law<a class="headerlink" href="#constitutive-law" title="Permalink to this headline">¶</a></h3>
<p>Basically <a class="reference external" href="https://en.wikipedia.org/wiki/Hooke%27s_law#Plane_strain">Hooke’s law in plane strain</a> with the factor <span class="math notranslate nohighlight">\((1-\omega)\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\boldsymbol \sigma &amp;= (1 - \omega(\kappa)) \boldsymbol C : \boldsymbol \varepsilon \\
\frac{\partial \boldsymbol \sigma}{\partial \boldsymbol \varepsilon} &amp;= (1 - \omega) \boldsymbol C  \\
\frac{\partial \boldsymbol \sigma}{\partial \bar \varepsilon} &amp;= - \omega \boldsymbol C : \boldsymbol \varepsilon \frac{\mathrm d \omega}{\mathrm d\kappa}\frac{\mathrm d\kappa}{\mathrm d \bar \varepsilon}\end{split}\]</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hooke</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dkappa_de</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    mat:</span>
<span class="sd">        material parameters</span>
<span class="sd">    eps:</span>
<span class="sd">        vector of Nx3 where each of the N rows is a 2D strain in Voigt notation</span>
<span class="sd">    kappa:</span>
<span class="sd">        current value of the history variable kappa</span>
<span class="sd">    dkappa_de:</span>
<span class="sd">        derivative of kappa w.r.t the nonlocal equivalent strains e</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">nu</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nu</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nu</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">E</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">nu</span><span class="p">))</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">]])</span>

    <span class="n">w</span><span class="p">,</span> <span class="n">dw</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">dmg</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">kappa</span><span class="p">)</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">eps</span> <span class="o">@</span> <span class="n">C</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">dsigma_deps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kappa</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">dsigma_de</span> <span class="o">=</span> <span class="o">-</span><span class="n">eps</span> <span class="o">@</span> <span class="n">C</span> <span class="o">*</span> <span class="n">dw</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">dkappa_de</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">dsigma_deps</span><span class="p">,</span> <span class="n">dsigma_de</span>
</pre></div>
</div>
</div>
<div class="section" id="strain-norm">
<h3>Strain norm<a class="headerlink" href="#strain-norm" title="Permalink to this headline">¶</a></h3>
<p>The local equivalent strain <span class="math notranslate nohighlight">\(\| \boldsymbol \varepsilon \|\)</span> is defined as</p>
<div class="math notranslate nohighlight">
\[\|\boldsymbol \varepsilon\| = \frac{k-1}{2k(1-2\nu)}I_1 + \frac{1}{2k}\sqrt{\left(\frac{k-1}{1-2\nu}I_1\right)^2 + \frac{2k}{(1+\nu)^2}J_2}.\]</div>
<p><span class="math notranslate nohighlight">\(I_1\)</span> is the first strain invariant and <span class="math notranslate nohighlight">\(J_2\)</span> is the second deviatoric strain invariant.
The parameter <span class="math notranslate nohighlight">\(k=f_c/f_t\)</span> controls different material responses in compression (compressive strength <span class="math notranslate nohighlight">\(f_c\)</span>) and tension (tensile strength <span class="math notranslate nohighlight">\(f_t\)</span>).</p>
<p>See: <a class="reference external" href="http://dx.doi.org/10.1016/0045-7949(94)00501-S">Comparison of nonlocal approaches in continuum damage mechanics, de Vree et al., 1995</a></p>
<p>Note that the implementation here is only valid for 2D plane strain!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">modified_mises_strain_norm</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
    <span class="n">nu</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">nu</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">k</span>

    <span class="n">K1</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">nu</span><span class="p">))</span>
    <span class="n">K2</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">nu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">exx</span><span class="p">,</span> <span class="n">eyy</span><span class="p">,</span> <span class="n">exy</span> <span class="o">=</span> <span class="n">eps</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">3</span><span class="p">],</span> <span class="n">eps</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">],</span> <span class="n">eps</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">I1</span> <span class="o">=</span> <span class="n">exx</span> <span class="o">+</span> <span class="n">eyy</span>
    <span class="n">J2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="o">*</span> <span class="p">((</span><span class="n">exx</span> <span class="o">-</span> <span class="n">eyy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">exx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">eyy</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">exy</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">K1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">K2</span> <span class="o">*</span> <span class="n">J2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0e-14</span>
    <span class="n">eeq</span> <span class="o">=</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">+</span> <span class="n">A</span>

    <span class="n">dJ2dexx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">exx</span> <span class="o">-</span> <span class="n">eyy</span><span class="p">)</span>
    <span class="n">dJ2deyy</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">eyy</span> <span class="o">-</span> <span class="n">exx</span><span class="p">)</span>
    <span class="n">dJ2dexy</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">exy</span>

    <span class="n">deeq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">deeq</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">+</span> <span class="n">K2</span> <span class="o">*</span> <span class="n">dJ2dexx</span><span class="p">)</span>
    <span class="n">deeq</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">+</span> <span class="n">K2</span> <span class="o">*</span> <span class="n">dJ2deyy</span><span class="p">)</span>
    <span class="n">deeq</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K2</span> <span class="o">*</span> <span class="n">dJ2dexy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eeq</span><span class="p">,</span> <span class="n">deeq</span>
</pre></div>
</div>
</div>
<div class="section" id="complete-constitutive-class">
<h3>Complete constitutive class<a class="headerlink" href="#complete-constitutive-class" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>contains the material parameters</p></li>
<li><p>stores the values of all integration points</p></li>
<li><p>calculates those fields for given <span class="math notranslate nohighlight">\(\boldsymbol \varepsilon, \bar \varepsilon\)</span></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GDMPlaneStrain</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Young&#39;s modulus          [N/mm²]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="mf">20000.0</span>
        <span class="c1"># Poisson&#39;s ratio            [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="c1"># nonlocal length parameter [mm]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="c1"># tensile strength          [N/mm²]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ft</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="c1"># compressive-tensile ratio   [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="c1"># residual strength factor   [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.99</span>
        <span class="c1"># fracture energy parameters [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="c1"># history variable           [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># damage law</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmg</span> <span class="o">=</span> <span class="n">damage_exponential</span>

    <span class="k">def</span> <span class="nf">eps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sym</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">as_vector</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">kappa_kkt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps_flat</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_kkt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">dkappa_de</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">kappa</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">eps</span> <span class="o">=</span> <span class="n">eps_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsigma_deps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsigma_de</span> <span class="o">=</span> <span class="n">hooke</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">dkappa_de</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eeq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deeq</span> <span class="o">=</span> <span class="n">modified_mises_strain_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps_flat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_kkt</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="quadrature-space-formulation">
<h2>Quadrature space formulation<a class="headerlink" href="#quadrature-space-formulation" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>Degrees of freedom in a mixed function space</dt><dd><ul class="simple">
<li><p>u = [d, e]</p></li>
<li><p>u = total mixed vector</p></li>
<li><p>d = displacement field <span class="math notranslate nohighlight">\(\boldsymbol d\)</span></p></li>
<li><p>e = nonlocal equivalent strain field <span class="math notranslate nohighlight">\(\bar \varepsilon\)</span></p></li>
</ul>
</dd>
</dl>
<p>Momentum balance + Screened Poisson …</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Rd</span> <span class="o">=</span> <span class="n">eps</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="p">:</span> <span class="n">sigma</span><span class="p">(</span><span class="n">eps</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">Re</span> <span class="o">=</span> <span class="n">de</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">grad</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">.</span> <span class="n">l</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>  <span class="o">-</span> <span class="n">de</span> <span class="o">*</span> <span class="n">eeq</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
<p>plus their derivatives</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dRd</span><span class="o">/</span><span class="n">dd</span> <span class="o">=</span> <span class="n">eps</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">dSigma_deps</span><span class="p">)</span> <span class="o">*</span> <span class="n">eps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">dRd</span><span class="o">/</span><span class="n">de</span> <span class="o">=</span> <span class="n">de</span> <span class="o">*</span> <span class="p">(</span><span class="n">dSigma_de</span> <span class="o">*</span> <span class="n">eps</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> <span class="o">*</span><span class="n">dx</span>
<span class="n">dRe</span><span class="o">/</span><span class="n">dd</span> <span class="o">=</span> <span class="n">eps</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">deeq_deps</span><span class="p">)</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">dx</span>
<span class="n">dRe</span><span class="o">/</span><span class="n">de</span> <span class="o">=</span> <span class="n">de</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">+</span> <span class="n">grad</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">.</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
</pre></div>
</div>
<p>The <em>trivial</em> terms in the equations above are implemented using FEniCS
forms. The non-trivial ones are defined as functions with prefix <code class="docutils literal notranslate"><span class="pre">q_</span></code> in
appropriately-sized quadrature function spaces. The values for those functions
are calculated in the <code class="docutils literal notranslate"><span class="pre">GDMPlaneStrain</span></code> class above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GDM</span><span class="p">(</span><span class="n">NonlinearProblem</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">NonlinearProblem</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="n">deg_d</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">deg_e</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">deg_q</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;quadrature_degree&quot;</span><span class="p">:</span> <span class="n">deg_q</span><span class="p">,</span> <span class="s2">&quot;quadrature_scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">}</span>
        <span class="n">dxm</span> <span class="o">=</span> <span class="n">dx</span><span class="p">(</span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span>

        <span class="c1"># solution field</span>
        <span class="n">Ed</span> <span class="o">=</span> <span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">deg_d</span><span class="p">)</span>
        <span class="n">Ee</span> <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">deg_e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Vu</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">Ed</span> <span class="o">*</span> <span class="n">Ee</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vu</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;d-e mixed space&quot;</span><span class="p">)</span>

        <span class="c1"># generic quadrature function spaces</span>
        <span class="n">q</span> <span class="o">=</span> <span class="s2">&quot;Quadrature&quot;</span>
        <span class="n">voigt</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">QF</span> <span class="o">=</span> <span class="n">FiniteElement</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">deg_q</span><span class="p">,</span> <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
        <span class="n">QV</span> <span class="o">=</span> <span class="n">VectorElement</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">deg_q</span><span class="p">,</span> <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">voigt</span><span class="p">)</span>
        <span class="n">QT</span> <span class="o">=</span> <span class="n">TensorElement</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">deg_q</span><span class="p">,</span> <span class="n">quad_scheme</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">voigt</span><span class="p">,</span> <span class="n">voigt</span><span class="p">))</span>
        <span class="n">VQF</span><span class="p">,</span> <span class="n">VQV</span><span class="p">,</span> <span class="n">VQT</span> <span class="o">=</span> <span class="p">[</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span> <span class="k">for</span> <span class="n">Q</span> <span class="ow">in</span> <span class="p">[</span><span class="n">QF</span><span class="p">,</span> <span class="n">QV</span><span class="p">,</span> <span class="n">QT</span><span class="p">]]</span>

        <span class="c1"># quadrature function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_sigma</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQV</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;current stresses&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_eps</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQV</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;current strains&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_e</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQF</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;current nonlocal equivalent strains&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_k</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQF</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;current history variable kappa&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_eeq</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQF</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;current (local) equivalent strain (norm)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_deps</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQT</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;stress-strain tangent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_de</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQV</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;stress-nonlocal-strain tangent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_deeq_deps</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">VQV</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;equivalent-strain-strain tangent&quot;</span><span class="p">)</span>

        <span class="n">dd</span><span class="p">,</span> <span class="n">de</span> <span class="o">=</span> <span class="n">TrialFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vu</span><span class="p">)</span>
        <span class="n">d_</span><span class="p">,</span> <span class="n">e_</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vu</span><span class="p">)</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f_d</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;f_d&quot;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">f_d</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">eps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">f_d</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">eps</span><span class="p">(</span><span class="n">d_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">+=</span> <span class="n">e_</span> <span class="o">*</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_eeq</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">+=</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">e_</span><span class="p">),</span> <span class="n">mat</span><span class="o">.</span><span class="n">l</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">grad</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">=</span> <span class="n">f_d</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">eps</span><span class="p">(</span><span class="n">d_</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_deps</span> <span class="o">*</span> <span class="n">eps</span><span class="p">(</span><span class="n">dd</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">+=</span> <span class="n">f_d</span> <span class="o">*</span> <span class="n">inner</span><span class="p">(</span><span class="n">eps</span><span class="p">(</span><span class="n">d_</span><span class="p">),</span>  <span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_de</span> <span class="o">*</span> <span class="n">de</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">+=</span> <span class="n">e_</span> <span class="o">*</span> <span class="p">(</span><span class="n">de</span> <span class="o">-</span> <span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_deeq_deps</span><span class="p">,</span> <span class="n">eps</span><span class="p">(</span><span class="n">dd</span><span class="p">)))</span> <span class="o">*</span> <span class="n">dxm</span>
        <span class="c1">#∂grad(e)/∂e de = linear terms of grad(e+de) = grad(de)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dR</span> <span class="o">+=</span> <span class="n">dot</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">e_</span><span class="p">),</span> <span class="n">mat</span><span class="o">.</span><span class="n">l</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">de</span><span class="p">)))</span> <span class="o">*</span> <span class="n">dxm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_eps</span> <span class="o">=</span> <span class="n">LocalProjector</span><span class="p">(</span><span class="n">eps</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">VQV</span><span class="p">,</span> <span class="n">dxm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_e</span> <span class="o">=</span> <span class="n">LocalProjector</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">VQF</span><span class="p">,</span> <span class="n">dxm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">evaluate_material</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># project the strain and the nonlocal equivalent strains onto</span>
        <span class="c1"># their quadrature spaces and ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_eps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_eps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_e</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_e</span><span class="p">)</span>

        <span class="n">eps_flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_eps</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_e</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">()</span>

        <span class="c1"># ... &quot;manually&quot; evaluate_material the material ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">eps_flat</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># ... and write the calculated values into their quadrature spaces.</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_eeq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">eeq</span><span class="p">)</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_deeq_deps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">deeq</span><span class="p">)</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_sigma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_deps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">dsigma_deps</span><span class="p">)</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_dsigma_de</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">dsigma_de</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_e</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_e</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">())</span>
        <span class="n">set_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span> <span class="c1"># just for post processing</span>

    <span class="k">def</span> <span class="nf">set_bcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bcs</span><span class="p">):</span>
        <span class="c1"># Only now (with the bcs) can we initialize the assembler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">=</span> <span class="n">SystemAssembler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You need to `.set_bcs(bcs)` before the solve!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_material</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">J</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre></div>
</div>
<dl class="simple">
<dt><strong>Remark:</strong> Subclassing from <code class="docutils literal notranslate"><span class="pre">dolfin.NonlinearProblem</span></code> …</dt><dd><ul class="simple">
<li><p>… is rather straight forward as we only need to pass our forms and boundary
conditions to the <code class="docutils literal notranslate"><span class="pre">dolfin.SystemAssembler</span></code> and call it in the
overwritten methods <code class="docutils literal notranslate"><span class="pre">F</span></code> (assembles the out-of-balance forces) and <code class="docutils literal notranslate"><span class="pre">J</span></code>
(assembles the tangent) …</p></li>
<li><p>… and allows us to directly use <code class="docutils literal notranslate"><span class="pre">dolfin.NewtonSolver</span></code> - the Newton-Raphson
implementation of FEniCS. Note that this algorithm (as probably every NR)
always evaluates <code class="docutils literal notranslate"><span class="pre">F</span></code> before <code class="docutils literal notranslate"><span class="pre">J</span></code>. So it is sufficient to perform
the <code class="docutils literal notranslate"><span class="pre">GDM.evaluate_material</span></code> only in <code class="docutils literal notranslate"><span class="pre">F</span></code>.</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="comparison-with-the-analytic-solution">
<h3>Comparison with the analytic solution<a class="headerlink" href="#comparison-with-the-analytic-solution" title="Permalink to this headline">¶</a></h3>
<p>The Peerlings paper cited above includes a discussion on an analytic solution
of the model for the <code class="docutils literal notranslate"><span class="pre">damage_perfect</span></code> damage law. A 1D bar of length <span class="math notranslate nohighlight">\(L\)</span>
(here modeled as a thin 2D structure) has a cross section reduction <span class="math notranslate nohighlight">\(\alpha\)</span>
over the length of <span class="math notranslate nohighlight">\(W\)</span> and is loaded by a displacement BC <span class="math notranslate nohighlight">\(\Delta L\)</span>.</p>
<dl class="simple">
<dt>Three regions form:</dt><dd><ul class="simple">
<li><p>damage in the weakened cross section</p></li>
<li><p>damage in the unweakened cross section</p></li>
<li><p>no damage</p></li>
</ul>
</dd>
</dl>
<p>and the authors provide a solution of the PDE system for each of the regions.
Finding the remaining integration constants is left to the reader. Here, it
is solved using <code class="docutils literal notranslate"><span class="pre">sympy</span></code>. We also subclass from <code class="docutils literal notranslate"><span class="pre">dolfin.UserExpression</span></code> to
interpolate the analytic solution into function spaces or calculate error norms.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PeerlingsAnalytic</span><span class="p">(</span><span class="n">UserExpression</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="mf">20000.0</span><span class="p">,</span> <span class="mf">1.0e-4</span><span class="p">,</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_coeffs</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The analytic solution is following Peerlings paper (1996) but with</span>
<span class="sd">        b(paper) = b^2 (here)</span>
<span class="sd">        g(paper) = g^2 (here)</span>
<span class="sd">        c(paper) = l^2 (here)</span>
<span class="sd">        This modification eliminates all the sqrts in the formulations.</span>
<span class="sd">        Plus: the formulation of the GDM in terms of l ( = sqrt(c) ) is</span>
<span class="sd">        more common in modern publications.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># imports only used here...</span>
        <span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">lambdify</span>
        <span class="kn">import</span> <span class="nn">scipy.optimize</span>

        <span class="c1"># unknowns</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">unknowns</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s2">&quot;A1, A2, B1, B2, C, b, g, w&quot;</span><span class="p">)</span>
        <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">unknowns</span>

        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span>
        <span class="n">kappa0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span>

        <span class="c1"># 0 &lt;= x &lt;= W/2</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">g</span> <span class="o">/</span> <span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># W/2 &lt;  x &lt;= w/2</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">B1</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">B2</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="c1"># w/2 &lt;  x &lt;= L/2</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span> <span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">kappa0</span>

        <span class="n">de1</span><span class="p">,</span> <span class="n">de2</span><span class="p">,</span> <span class="n">de3</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">e2</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">e3</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">eq1</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">e1</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">e2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">eq2</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">de1</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">de2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">eq3</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">kappa0</span><span class="p">)</span>
        <span class="n">eq4</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">de2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">de3</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">eq5</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">e3</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">kappa0</span><span class="p">)</span>
        <span class="n">eq6</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span><span class="n">de3</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">eq7</span> <span class="o">=</span> <span class="n">N</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">))</span>
        <span class="n">eq8</span> <span class="o">=</span> <span class="n">N</span><span class="p">(</span>
            <span class="n">integrate</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">integrate</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">integrate</span><span class="p">(</span><span class="n">e3</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltaL</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="n">eqs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">lambdify</span><span class="p">(</span><span class="n">unknowns</span><span class="p">,</span> <span class="n">eq</span><span class="p">)</span> <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="p">[</span><span class="n">eq1</span><span class="p">,</span> <span class="n">eq2</span><span class="p">,</span> <span class="n">eq3</span><span class="p">,</span> <span class="n">eq4</span><span class="p">,</span> <span class="n">eq5</span><span class="p">,</span> <span class="n">eq6</span><span class="p">,</span> <span class="n">eq7</span><span class="p">,</span> <span class="n">eq8</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="k">def</span> <span class="nf">global_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eqs</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)])</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">root</span><span class="p">(</span>
            <span class="n">global_func</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5e2</span><span class="p">,</span> <span class="mf">3e-7</span><span class="p">,</span> <span class="mf">7e-3</span><span class="p">,</span> <span class="mf">3e-3</span><span class="p">,</span> <span class="mf">3e-1</span><span class="p">,</span> <span class="mf">2e-1</span><span class="p">,</span> <span class="mf">4e1</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Could not find the correct coefficients. Try to tweak the initial values.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">e</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coeffs</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">C</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">g</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">B1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">B2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa0</span>
                <span class="o">+</span> <span class="n">A1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">A2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>Using this, we can rebuild the example with our <code class="docutils literal notranslate"><span class="pre">GDM</span></code> nonlinear problem and
compare.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">gdm_error</span><span class="p">(</span><span class="n">n_elements</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ... evaluated in 2D</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">e_exact</span> <span class="o">=</span> <span class="n">PeerlingsAnalytic</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">RectangleMesh</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">e_exact</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">n_elements</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">GDMPlaneStrain</span><span class="p">()</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">e_exact</span><span class="o">.</span><span class="n">E</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">ft</span> <span class="o">=</span> <span class="n">e_exact</span><span class="o">.</span><span class="n">E</span> <span class="o">*</span> <span class="n">e_exact</span><span class="o">.</span><span class="n">kappa0</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">e_exact</span><span class="o">.</span><span class="n">l</span>
    <span class="n">mat</span><span class="o">.</span><span class="n">dmg</span> <span class="o">=</span> <span class="n">damage_perfect</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span>
        <span class="s2">&quot;x[0] &lt;= W/2. ? 10.0 * (1. - a) : 10.0&quot;</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="n">e_exact</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">e_exact</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">gdm</span> <span class="o">=</span> <span class="n">GDM</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">f_d</span><span class="o">=</span><span class="n">area</span><span class="p">)</span>

    <span class="n">bc_expr</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s2">&quot;t*d&quot;</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">e_exact</span><span class="o">.</span><span class="n">deltaL</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">bc0</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">plane_at</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">bc1</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">bc_expr</span><span class="p">,</span> <span class="n">plane_at</span><span class="p">(</span><span class="n">e_exact</span><span class="o">.</span><span class="n">L</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
    <span class="n">gdm</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">([</span><span class="n">bc0</span><span class="p">,</span> <span class="n">bc1</span><span class="p">])</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">NewtonSolver</span><span class="p">()</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;linear_solver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mumps&quot;</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;maximum_iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;error_on_nonconvergence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
        <span class="n">bc_expr</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">assert</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">gdm</span><span class="p">,</span> <span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">())[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">e_fem</span> <span class="o">=</span> <span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">errornorm</span><span class="p">(</span><span class="n">e_exact</span><span class="p">,</span> <span class="n">e_fem</span><span class="p">)</span>
</pre></div>
</div>
<p>This error should converge to zero upon mesh refinement and can be used to
determine the order of convergence of the model.</p>
<img alt="../_images/gdm_convergence.png" src="../_images/gdm_convergence.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">convergence_test</span><span class="p">():</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">]</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gdm_error</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="n">ps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">errors</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ns</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="s2">&quot;-ko&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;# elements&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;gdm_convergence.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="three-point-bending-test">
<h2>Three-point bending test<a class="headerlink" href="#three-point-bending-test" title="Permalink to this headline">¶</a></h2>
<p>Just a more exciting example.</p>
<img alt="../_images/gdm_bending.gif" src="../_images/gdm_bending.gif" />
<p>Note that we pass our <code class="docutils literal notranslate"><span class="pre">GDM</span></code> class as well as the linear solver as a parameter.
These can be modified to use an <a class="reference external" href="gradient_damage_iterative.html">iterative solver</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">three_point_bending</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">GDM</span><span class="p">,</span> <span class="n">linear_solver</span><span class="o">=</span><span class="n">LUSolver</span><span class="p">(</span><span class="s2">&quot;mumps&quot;</span><span class="p">)):</span>
    <span class="n">LX</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">LY</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">LX_load</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">mesh</span> <span class="o">=</span> <span class="n">RectangleMesh</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Point</span><span class="p">(</span><span class="n">LX</span><span class="p">,</span> <span class="n">LY</span><span class="p">),</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">mat</span> <span class="o">=</span> <span class="n">GDMPlaneStrain</span><span class="p">()</span>
    <span class="n">gdm</span> <span class="o">=</span> <span class="n">problem</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

    <span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">point_at</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">point_at</span><span class="p">((</span><span class="n">LX</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">top</span> <span class="o">=</span> <span class="n">within_range</span><span class="p">([(</span><span class="n">LX</span> <span class="o">-</span> <span class="n">LX_load</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">LY</span><span class="p">],</span> <span class="p">[(</span><span class="n">LX</span> <span class="o">+</span> <span class="n">LX_load</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LY</span><span class="p">],</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">bc_expr</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">(</span><span class="s2">&quot;d*t&quot;</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">bcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">bc_expr</span><span class="p">,</span> <span class="n">top</span><span class="p">))</span>
    <span class="n">bcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pointwise&quot;</span><span class="p">))</span>
    <span class="n">bcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pointwise&quot;</span><span class="p">))</span>
    <span class="n">bcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DirichletBC</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">Vd</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;pointwise&quot;</span><span class="p">))</span>

    <span class="n">gdm</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">bcs</span><span class="p">)</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">NewtonSolver</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">comm_world</span><span class="p">,</span> <span class="n">linear_solver</span><span class="p">,</span> <span class="n">PETScFactory</span><span class="o">.</span><span class="n">instance</span><span class="p">())</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;linear_solver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mumps&quot;</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;maximum_iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">solver</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;error_on_nonconvergence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">bc_expr</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">gdm</span><span class="p">,</span> <span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">vector</span><span class="p">())</span>

    <span class="n">ld</span> <span class="o">=</span> <span class="n">LoadDisplacementCurve</span><span class="p">(</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ld</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ld</span><span class="o">.</span><span class="n">is_root</span><span class="p">:</span>
        <span class="n">set_log_level</span><span class="p">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="n">fff</span> <span class="o">=</span> <span class="n">XDMFFile</span><span class="p">(</span><span class="s2">&quot;output.xdmf&quot;</span><span class="p">)</span>
    <span class="n">fff</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;functions_share_mesh&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">fff</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;flush_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">plot_space</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pp</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="n">gdm</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># this fixes XDMF time stamps</span>
        <span class="kn">import</span> <span class="nn">locale</span>
        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_NUMERIC</span><span class="p">,</span> <span class="s2">&quot;en_US.UTF-8&quot;</span><span class="p">)</span>
        <span class="n">fff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">fff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># plot the damage</span>
        <span class="n">q_k</span> <span class="o">=</span> <span class="n">gdm</span><span class="o">.</span><span class="n">q_k</span>
        <span class="n">q_w</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">q_k</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
        <span class="n">set_q</span><span class="p">(</span><span class="n">q_w</span><span class="p">,</span> <span class="n">mat</span><span class="o">.</span><span class="n">dmg</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">q_k</span><span class="o">.</span><span class="n">vector</span><span class="p">()</span><span class="o">.</span><span class="n">get_local</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">q_w</span><span class="p">,</span> <span class="n">plot_space</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="n">ld</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">assemble</span><span class="p">(</span><span class="n">gdm</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>

    <span class="n">TimeStepper</span><span class="p">(</span><span class="n">solve</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">gdm</span><span class="o">.</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">adaptive</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">gdm_error</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-8</span>
    <span class="n">convergence_test</span><span class="p">()</span>
    <span class="n">three_point_bending</span><span class="p">()</span>
    <span class="n">list_timings</span><span class="p">(</span><span class="n">TimingClear</span><span class="o">.</span><span class="n">keep</span><span class="p">,</span> <span class="p">[</span><span class="n">TimingType</span><span class="o">.</span><span class="n">wall</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="extensions">
<h2>Extensions<a class="headerlink" href="#extensions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>make everything dimension independent</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="gradient_damage_iterative.html" class="btn btn-neutral float-right" title="Note on iterative solvers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="example.html" class="btn btn-neutral float-left" title="Material models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Thomas Titscher, Sjard Mathis Rosenbusch, Philipp Diercks.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>